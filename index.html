<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Frequency Rodent Repeller</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 100%;
        }
        h1 { margin-top: 0; font-size: 1.5rem; text-align: center; color: #ff5252; }
        .status {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            height: 1.2em;
            color: #4caf50;
            font-size: 0.95rem; /* Slightly smaller to fit info */
        }
        .control-group { margin-bottom: 30px; }
        label { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; align-items: center; font-weight: 500; }

        /* Standard Single Slider (for Rate) */
        input[type="range"].single-slider { width: 100%; cursor: pointer; accent-color: #ff5252; }

        /* --- DUAL THUMB SLIDER CSS --- */
        .range-wrapper {
            position: relative;
            width: 100%;
            height: 30px;
        }

        /* The inputs are invisible but clickable */
        input[type="range"].dual-input {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            position: absolute;
            background: none;
            pointer-events: none; /* Clicks pass through */
            z-index: 2;
            top: 50%;
            transform: translateY(-50%);
            margin: 0;
        }

        /* The thumbs (handles) */
        input[type="range"].dual-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: auto; /* Catch clicks */
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.6);
            border: 1px solid #2d2d2d;
            margin-top: -9px;
        }
        input[type="range"].dual-input::-moz-range-thumb {
            pointer-events: auto;
            height: 22px;
            width: 22px;
            border: none;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.6);
        }

        /* The Visual Track Background */
        .slider-track {
            width: 100%;
            height: 6px;
            position: absolute;
            background-color: #444;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }

        /* The Colored Range Bars */
        .slider-range-color {
            height: 6px;
            position: absolute;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        /* --------------------------- */

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-start { background-color: #4caf50; color: white; }
        .btn-start:hover { background-color: #45a049; }
        .btn-stop { background-color: #ff5252; color: white; }
        .btn-stop:hover { background-color: #e53935; }
        .value-display { color: #aaa; font-family: monospace; font-size: 0.9rem; }
        .warning {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #aaa;
            background: #252525;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #ff9800;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Variable Repeller</h1>
    <div class="status" id="statusText">Ready</div>

    <div class="control-group">
        <label>
            Frequency Range
            <span class="value-display" id="freqDisplay">18000Hz - 22000Hz</span>
        </label>
        <div class="range-wrapper">
            <div class="slider-track"></div>
            <div class="slider-range-color" id="freqBar" style="background-color: #ff5252;"></div>
            <input type="range" class="dual-input" id="freqMin" min="10000" max="22000" value="18000">
            <input type="range" class="dual-input" id="freqMax" min="10000" max="22000" value="22000">
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-top: 5px;">
            Randomized sweep between these two pitches.
        </div>
    </div>

    <div class="control-group">
        <label>
            Looming Intensity
            <span class="value-display" id="volDisplay">20% - 100%</span>
        </label>
        <div class="range-wrapper">
            <div class="slider-track"></div>
            <div class="slider-range-color" id="volBar" style="background-color: #2196f3;"></div>
            <input type="range" class="dual-input" id="volMin" min="0" max="100" value="20">
            <input type="range" class="dual-input" id="volMax" min="0" max="100" value="100">
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-top: 5px;">
            Pulses swell from Min Volume to Max Volume.
        </div>
    </div>

    <div class="control-group">
        <label>
            Pulse Wait Time
            <span class="value-display" id="rateVal">Medium</span>
        </label>
        <input type="range" class="single-slider" id="pulseRate" min="1" max="10" value="5">
    </div>

    <div class="btn-group">
        <button class="btn-start" id="startBtn">PLAY</button>
        <button class="btn-stop" id="stopBtn">STOP</button>
    </div>

    <div class="warning">
        <strong>⚠️ Logic:</strong>
        1. Pick random Freq in Red range.<br>
        2. Swell volume within Blue range.
    </div>
</div>

<script>
    let audioCtx;
    let mainGain;
    let isPlaying = false;
    let timeoutId;

    // DOM Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('statusText');
    const rateInput = document.getElementById('pulseRate');

    // Frequency Elements
    const freqMinInput = document.getElementById('freqMin');
    const freqMaxInput = document.getElementById('freqMax');
    const freqBar = document.getElementById('freqBar');
    const freqDisplay = document.getElementById('freqDisplay');

    // Volume Elements
    const volMinInput = document.getElementById('volMin');
    const volMaxInput = document.getElementById('volMax');
    const volBar = document.getElementById('volBar');
    const volDisplay = document.getElementById('volDisplay');

    // --- UI UPDATERS ---

    // 1. Update Intensity (0-100 Scale)
    function updateVolUI() {
        let min = parseInt(volMinInput.value);
        let max = parseInt(volMaxInput.value);

        // Anti-Collision
        if (min > max - 5) {
            if(this === volMinInput) { volMinInput.value = max - 5; min = max - 5; }
            else { volMaxInput.value = min + 5; max = min + 5; }
        }

        // CSS Updates (0-100 makes this easy)
        volBar.style.left = min + "%";
        volBar.style.width = (max - min) + "%";
        volDisplay.textContent = `${min}% - ${max}%`;
    }

    // 2. Update Frequency (10000-22000 Scale)
    function updateFreqUI() {
        let min = parseInt(freqMinInput.value);
        let max = parseInt(freqMaxInput.value);
        const collisionBuffer = 500; // 500Hz minimum gap

        // Anti-Collision
        if (min > max - collisionBuffer) {
            if(this === freqMinInput) {
                freqMinInput.value = max - collisionBuffer;
                min = max - collisionBuffer;
            } else {
                freqMaxInput.value = min + collisionBuffer;
                max = min + collisionBuffer;
            }
        }

        // Normalization for CSS (Convert to 0-100%)
        // Range is 12000 (22000 - 10000)
        // Offset is 10000
        const totalRange = 12000;
        const minOffset = 10000;

        const minPercent = ((min - minOffset) / totalRange) * 100;
        const maxPercent = ((max - minOffset) / totalRange) * 100;

        freqBar.style.left = minPercent + "%";
        freqBar.style.width = (maxPercent - minPercent) + "%";
        freqDisplay.textContent = `${min}Hz - ${max}Hz`;
    }

    // 3. Update Rate Text
    function updateRateUI() {
        let rateText = "Medium";
        if(rateInput.value < 4) rateText = "Low";
        if(rateInput.value > 7) rateText = "High";
        document.getElementById('rateVal').textContent = rateText;
    }

    // Event Listeners
    volMinInput.addEventListener('input', updateVolUI);
    volMaxInput.addEventListener('input', updateVolUI);
    freqMinInput.addEventListener('input', updateFreqUI);
    freqMaxInput.addEventListener('input', updateFreqUI);
    rateInput.addEventListener('input', updateRateUI);

    // Initial Set
    updateVolUI();
    updateFreqUI();
    updateRateUI();

    // Helper: Random number in range
    const randomRange = (min, max) => Math.random() * (max - min) + min;

    // --- AUDIO ENGINE ---
    function playBurst() {
        if (!isPlaying) return;

        const osc = audioCtx.createOscillator();
        const burstGain = audioCtx.createGain();

        osc.connect(burstGain);
        burstGain.connect(mainGain);

        // --- FETCH PARAMETERS ---
        const fMin = parseInt(freqMinInput.value);
        const fMax = parseInt(freqMaxInput.value);
        const vMin = parseInt(volMinInput.value) / 100; // Convert to float
        const vMax = parseInt(volMaxInput.value) / 100; // Convert to float
        const activityLevel = parseInt(rateInput.value);

        // --- LOOMING VOLUME CALC ---
        const startVol = randomRange(vMin, vMax);
        // Ensure endVol is >= startVol for the "looming" swell effect
        const endVol = randomRange(startVol, vMax);

        // --- FREQUENCY CALC ---
        const startFreq = randomRange(fMin, fMax);
        const endFreq = randomRange(fMin, fMax);
        const duration = randomRange(0.5, 3.0);

        const now = audioCtx.currentTime;

        // Frequency Sweep
        osc.frequency.setValueAtTime(startFreq, now);
        osc.frequency.linearRampToValueAtTime(endFreq, now + duration);

        // Volume Envelope (Looming Swell)
        burstGain.gain.setValueAtTime(0, now);
        burstGain.gain.linearRampToValueAtTime(startVol, now + 0.1);
        burstGain.gain.linearRampToValueAtTime(endVol, now + duration);
        burstGain.gain.linearRampToValueAtTime(0, now + duration + 0.05);

        // Start and Stop
        osc.start(now);
        osc.stop(now + duration + 0.1);

        // Schedule Next
        const baseDelay = (11 - activityLevel) * 200;
        const randomDelay = Math.random() * 1500;
        const totalDelay = baseDelay + randomDelay;

        // Visual Feedback
        statusText.textContent = `Swell ${Math.round(startVol*100)}%➔${Math.round(endVol*100)}% | ${Math.round(startFreq)}Hz➔${Math.round(endFreq)}Hz`;

        timeoutId = setTimeout(playBurst, (duration * 1000) + totalDelay);
    }

    startBtn.addEventListener('click', () => {
        if (isPlaying) return;

        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        mainGain = audioCtx.createGain();
        mainGain.connect(audioCtx.destination);
        mainGain.gain.value = 1.0;

        isPlaying = true;
        statusText.textContent = "Running...";
        statusText.style.color = "#4caf50";
        playBurst();
    });

    stopBtn.addEventListener('click', () => {
        isPlaying = false;
        clearTimeout(timeoutId);
        statusText.textContent = "Stopped";
        statusText.style.color = "#ff5252";
        if (mainGain) mainGain.disconnect();
    });

</script>
</body>
</html>
